<!DOCTYPE html>
<html lang="en">
<head>
  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-87W6B0JP70"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-87W6B0JP70');
  </script>

<meta charset="UTF-8">
<title>Pinternship Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<style>
/* ===== YOUR ORIGINAL STYLES – UNCHANGED ===== */
body{margin:0;background:#f5f7fb;font-family:"Segoe UI",Roboto,Helvetica,Arial,sans-serif;color:#1f2937}
.header{background:linear-gradient(135deg,#1a237e,#3949ab);color:white;padding:24px;text-align:center}
.tabs{display:flex;justify-content:center;gap:12px;margin:20px;flex-wrap:wrap}
.tab{padding:10px 18px;background:#e8eaf6;border-radius:8px;cursor:pointer;font-weight:600;color:#1a237e}
.tab.active{background:#1a237e;color:white}
.tab-content{display:none;width:95%;max-width:1400px;margin:0 auto 30px;background:white;border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,0.12)}
.tab-content.active{display:block}
.dashboard-inner{display:flex;min-height:80vh}
.dashboard-menu{width:260px;background:#f3f4fb;border-right:1px solid #ddd;padding:12px}
.menu-item{padding:12px 14px;margin-bottom:8px;cursor:pointer;border-radius:6px;font-weight:600;color:#1a237e}
.menu-item.active{background:#1a237e;color:white}
.dashboard-view{flex:1;padding:18px;overflow:auto}
.status-row{display:flex;gap:12px;align-items:center;justify-content:space-between;flex-wrap:wrap;margin-bottom:14px}
.pill{padding:8px 12px;border-radius:999px;background:#eef2ff;color:#1a237e;font-weight:600;font-size:13px}
.muted{color:#6b7280;font-size:13px}
.search{display:flex;gap:10px;align-items:center}
.search input{width:320px;padding:10px;border-radius:10px;border:1px solid #d1d5db}
.table-wrap{border:1px solid #e5e7eb;border-radius:12px;overflow:auto}
table{width:100%;border-collapse:collapse;min-width:900px}
thead th{position:sticky;top:0;background:#00FF00;color:#D32F2F;font-weight:800;padding:12px}
tbody td{padding:10px 12px;border-bottom:1px solid #f0f2f5}
.num{text-align:right}
</style>
</head>

<body>

<div class="header">
  <h1>Pinternship Dashboard</h1>
  <p>Live Performance & Progress Overview</p>
</div>

<div class="tabs">
  <div class="tab active" data-tab="leaderboard">Leaderboard</div>
  <div class="tab" data-tab="cs">CS Progress</div>
  <div class="tab" data-tab="health">Health Points</div>
</div>

<!-- LEADERBOARD -->
<div class="tab-content active" id="tab-leaderboard">
  <div class="dashboard-inner">
    <div class="dashboard-view">
      <div class="pill" id="lb-pill">Loading…</div>
      <div class="table-wrap">
        <table id="lb-table"><thead></thead><tbody></tbody></table>
      </div>
    </div>
  </div>
</div>

<!-- CS -->
<div class="tab-content" id="tab-cs">
  <div class="dashboard-inner">
    <div class="dashboard-view">
      <div class="pill">CS Progress</div>
    </div>
  </div>
</div>

<!-- HEALTH POINTS -->
<div class="tab-content" id="tab-health">
  <div class="dashboard-inner">
    <div class="dashboard-view">
      <div class="status-row">
        <div class="pill">Health Points Leaderboard</div>
        <div class="search">
          <input id="hp-search" placeholder="Search name or email">
          <span class="muted" id="hp-meta"></span>
        </div>
      </div>

      <div class="table-wrap">
        <table id="hp-table"><thead></thead><tbody></tbody></table>
      </div>
    </div>
  </div>
</div>

<script>
/* ================= CONFIG ================= */
const API_URL =
"https://script.google.com/macros/s/AKfycbyU2YIGp55fzmJvhLP_DdNUTUCd6DbMHQUeayuFCL6xioWm7R0YB2L0KRftupQzGYR9Xw/exec";

const HP_API_URL =
"https://script.google.com/macros/s/AKfycbz0_gCBgqShslQHah-Dfw8Y0WIljrf2paTLsLhuSu8XfidmVlNcpd7lbu0aNMdM_LJxLg/exec";

/* ================= STATE ================= */
let apiData = null;
let hpData = null;
let hpLoaded = false;

/* ================= LEADERBOARD ================= */
async function loadAPI() {
  const res = await fetch(API_URL);
  apiData = await res.json();
  document.getElementById("lb-pill").textContent = "Loaded";
}

loadAPI();

/* ================= HEALTH POINTS ================= */
async function loadHealthPoints() {
  if (hpLoaded) return;
  hpLoaded = true;

  const meta = document.getElementById("hp-meta");
  meta.textContent = "Loading…";

  try {
    const res = await fetch(HP_API_URL, { cache: "no-store" });
    hpData = await res.json();
    renderHealthPoints();
  } catch (e) {
    meta.textContent = "Failed";
    console.error(e);
  }
}

function renderHealthPoints() {
  const table = document.getElementById("hp-table");
  const thead = table.querySelector("thead");
  const tbody = table.querySelector("tbody");
  const search = document.getElementById("hp-search");

  let rows = hpData.leaderboard || [];
  if (search.value) {
    const q = search.value.toLowerCase();
    rows = rows.filter(r =>
      r.Name.toLowerCase().includes(q) ||
      r.Email.toLowerCase().includes(q)
    );
  }

  thead.innerHTML = `
    <tr>
      <th>Rank</th><th>Name</th><th>Email</th>
      <th>Current HP</th><th>Base HP</th><th>Status</th><th>Details</th>
    </tr>
  `;

  tbody.innerHTML = "";
  rows.forEach((r,i)=>{
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td class="num">${i+1}</td>
      <td>${r.Name}</td>
      <td>${r.Email}</td>
      <td class="num">${r.Current_HP.toFixed(2)}</td>
      <td class="num">${r.Base_HP.toFixed(2)}</td>
      <td>${r.HP_Status}</td>
      <td><button onclick="viewHpDetail('${r.Email}')">View</button></td>
    `;
    tbody.appendChild(tr);
  });

  document.getElementById("hp-meta").textContent = `Students: ${rows.length}`;
}

document.getElementById("hp-search")
  .addEventListener("input", () => hpLoaded && renderHealthPoints());

/* ================= DETAIL ================= */
async function viewHpDetail(email) {
  const res = await fetch(`${HP_API_URL}?detail=1&email=${encodeURIComponent(email)}`);
  const data = await res.json();

  let html = `<h3>${email}</h3><table border="1" cellpadding="6">`;
  data.breakdown.forEach(r=>{
    html += `<tr><td>${r.AppliedDate}</td><td>${r.SourceRef}</td><td>${r.AppliedPercent}</td></tr>`;
  });
  html += "</table>";

  const w = window.open("", "_blank", "width=700,height=500");
  w.document.write(html);
}

/* ================= TABS ================= */
document.querySelectorAll(".tab").forEach(tab=>{
  tab.addEventListener("click",()=>{
    document.querySelectorAll(".tab").forEach(t=>t.classList.remove("active"));
    document.querySelectorAll(".tab-content").forEach(c=>c.classList.remove("active"));

    tab.classList.add("active");
    document.getElementById("tab-"+tab.dataset.tab).classList.add("active");

    if (tab.dataset.tab === "health") loadHealthPoints();
  });
});
</script>

</body>
</html>
